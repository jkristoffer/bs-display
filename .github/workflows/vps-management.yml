name: ğŸš€ VPS Management
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'VPS Action'
        required: true
        type: choice
        options: 
          - deploy
          - connect
          - status
          - cleanup
          - costs
          - create-base
          - update
        default: 'status'
      session_name:
        description: 'Session Name (for deploy/connect)'
        required: false
        type: string
        default: 'mobile-session'
      droplet_size:
        description: 'Droplet Size (for deploy)'
        required: false
        type: choice
        options:
          - s-1vcpu-2gb
          - s-2vcpu-4gb
          - s-4vcpu-8gb
        default: 's-2vcpu-4gb'

jobs:
  vps-management:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“‹ Job Info
        run: |
          echo "ğŸš€ **VPS Management Job Started**"
          echo "Action: ${{ inputs.action }}"
          echo "Session: ${{ inputs.session_name }}"
          echo "Size: ${{ inputs.droplet_size }}"
          echo "Triggered by: ${{ github.actor }}"
          
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup DigitalOcean CLI
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          
      - name: âœ… Verify doctl authentication
        run: |
          echo "Testing DigitalOcean CLI authentication..."
          doctl account get
          echo "âœ… Authentication successful"
          
      - name: ğŸ› ï¸ Make scripts executable
        run: |
          chmod +x vps-scripts/*.sh
          ls -la vps-scripts/
          
      - name: ğŸš€ Execute VPS Action
        id: vps-action
        run: |
          cd vps-scripts
          
          # Set environment variables for scripts
          export DO_SIZE="${{ inputs.droplet_size }}"
          export DO_REGION="nyc3"
          
          echo "Executing action: ${{ inputs.action }}"
          
          case "${{ inputs.action }}" in
            deploy)
              echo "ğŸš€ Deploying VPS: ${{ inputs.session_name }}"
              ./manage.sh deploy "${{ inputs.session_name }}"
              ;;
            connect)
              echo "ğŸ”— Getting connection info for: ${{ inputs.session_name }}"
              ./manage.sh connect "${{ inputs.session_name }}"
              ;;
            status)
              echo "ğŸ“Š Getting VPS status"
              ./manage.sh status
              ;;
            cleanup)
              echo "ğŸ§¹ Cleaning up resources"
              ./manage.sh cleanup
              ;;
            costs)
              echo "ğŸ’° Analyzing costs"
              ./manage.sh costs
              ;;
            create-base)
              echo "ğŸ—ï¸ Creating base snapshot"
              ./manage.sh create-base
              ;;
            update)
              echo "â¬†ï¸ Updating base snapshot"
              ./manage.sh update
              ;;
            *)
              echo "âŒ Invalid action: ${{ inputs.action }}"
              exit 1
              ;;
          esac
          
      - name: ğŸ’¾ Save session info
        if: inputs.action == 'deploy'
        run: |
          if [ -f vps-scripts/.last-session ]; then
            echo "SESSION_INFO<<EOF" >> $GITHUB_ENV
            cat vps-scripts/.last-session >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo "ğŸ“ Session info saved:"
            cat vps-scripts/.last-session
          else
            echo "âš ï¸ No session info file found"
          fi
          
      - name: ğŸ“± Create mobile-friendly summary
        if: always()
        run: |
          echo "## ğŸ“± VPS Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Session:** ${{ inputs.session_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Droplet Size:** ${{ inputs.droplet_size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.action }}" = "deploy" ] && [ -f "vps-scripts/.last-session" ]; then
            echo "### ğŸš€ Deployment Details" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat vps-scripts/.last-session >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ¯ Post results comment (deploy only)
        if: inputs.action == 'deploy' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let sessionInfo = 'Deployment completed successfully';
            try {
              if (fs.existsSync('vps-scripts/.last-session')) {
                sessionInfo = fs.readFileSync('vps-scripts/.last-session', 'utf8');
              }
            } catch (error) {
              console.log('Could not read session info:', error.message);
            }
            
            const comment = `ğŸš€ **VPS Deployed Successfully**
            
**Session:** \${{ inputs.session_name }}
**Size:** \${{ inputs.droplet_size }}
**Triggered by:** @\${{ github.actor }}

\\\`\\\`\\\`
${sessionInfo}
\\\`\\\`\\\`

ğŸ“± **Quick Access:**
- [View full run details](https://github.com/\${{ github.repository }}/actions/runs/\${{ github.run_id }})
- Use GitHub mobile app to access this info anywhere!

â° Deployed at: ${new Date().toISOString()}`;

            // Comment on the latest commit
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: comment
              });
            } catch (error) {
              console.log('Could not create commit comment:', error.message);
            }